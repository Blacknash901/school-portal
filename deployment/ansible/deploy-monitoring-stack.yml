---
# ============================================================================
# Monitoring Stack Deployment Playbook
# ============================================================================
#
# PURPOSE:
#   Deploy Prometheus, Grafana, and CloudWatch Exporter to MicroK8s.
#
# USAGE:
#   ansible-playbook -i inventory-production.yml deploy-monitoring-stack.yml
# ============================================================================

- name: Deploy Monitoring Stack
  hosts: production-server
  become: yes
  gather_facts: yes

  vars:
    k8s_dir: "/opt/monitor-app/k8s"
    monitoring_namespace: "monitoring"
    azure_tenant_id: "{{ lookup('env', 'AZURE_TENANT_ID') }}"
    azure_client_id_am: "{{ lookup('env', 'AZURE_CLIENT_ID_AM') }}"
    azure_client_secret_am: "{{ lookup('env', 'AZURE_CLIENT_SECRET_AM') }}"

  tasks:
    # ============================================================
    # Ensure MicroK8s is Running
    # ============================================================
    - name: Check if MicroK8s is running
      command: /snap/bin/microk8s status --wait-ready --timeout 10
      register: microk8s_status
      failed_when: false
      changed_when: false

    - name: Start MicroK8s if not running
      command: /snap/bin/microk8s start
      when: microk8s_status.rc != 0

    - name: Wait for MicroK8s to be ready
      command: /snap/bin/microk8s status --wait-ready
      when: microk8s_status.rc != 0
      changed_when: false
      retries: 10
      delay: 10
      register: microk8s_ready
      until: microk8s_ready.rc == 0

    - name: Create monitoring directory
      file:
        path: "{{ k8s_dir }}"
        state: directory
        mode: "0755"

    - name: Copy Kubernetes manifests
      copy:
        src: "{{ playbook_dir }}/../../monitor-app/k8s/"
        dest: "{{ k8s_dir }}/"
        mode: "0644"

    - name: Create monitoring namespace
      command: /snap/bin/microk8s kubectl create namespace {{ monitoring_namespace }}
      register: create_ns
      failed_when: false
      changed_when: "'created' in create_ns.stdout"

    - name: Delete old PVCs with incorrect storage class
      shell: |
        /snap/bin/microk8s kubectl delete pvc prometheus-storage grafana-storage -n {{ monitoring_namespace }} --ignore-not-found=true
      changed_when: false

    - name: Apply Prometheus Configuration
      command: /snap/bin/microk8s kubectl apply -f {{ k8s_dir }}/prometheus-config.yaml

    - name: Deploy Prometheus
      command: /snap/bin/microk8s kubectl apply -f {{ k8s_dir }}/prometheus-deployment.yaml

    - name: Deploy Grafana
      command: /snap/bin/microk8s kubectl apply -f {{ k8s_dir }}/grafana-deployment.yaml

    - name: Deploy Grafana Dashboards
      command: /snap/bin/microk8s kubectl apply -f {{ k8s_dir }}/grafana-dashboard.yaml

    - name: Deploy CloudWatch Exporter
      command: /snap/bin/microk8s kubectl apply -f {{ k8s_dir }}/cloudwatch-exporter.yaml

    - name: Deploy Kube State Metrics
      command: /snap/bin/microk8s kubectl apply -f {{ k8s_dir }}/kube-state-metrics.yaml

    - name: Deploy Blackbox Exporter
      command: /snap/bin/microk8s kubectl apply -f {{ k8s_dir }}/blackbox-exporter.yaml

    - name: Create Alertmanager webhook secrets
      shell: |
        cat <<EOF | /snap/bin/microk8s kubectl apply -f -
        apiVersion: v1
        kind: Secret
        metadata:
          name: alertmanager-webhook-secrets
          namespace: {{ monitoring_namespace }}
        type: Opaque
        stringData:
          AZURE_TENANT_ID: "{{ azure_tenant_id }}"
          AZURE_CLIENT_ID_AM: "{{ azure_client_id_am }}"
          AZURE_CLIENT_SECRET_AM: "{{ azure_client_secret_am }}"
          EMAIL_TO: "portal_status_notification@cecre.net"
        EOF
      when: azure_tenant_id != "" and azure_client_id_am != "" and azure_client_secret_am != ""
      no_log: true

    - name: Deploy Alertmanager
      command: /snap/bin/microk8s kubectl apply -f {{ k8s_dir }}/alertmanager-deployment.yaml

    - name: Deploy Monitoring Ingress
      command: /snap/bin/microk8s kubectl apply -f {{ k8s_dir }}/monitoring-ingress.yaml

    - name: Wait for Prometheus
      command: /snap/bin/microk8s kubectl wait --for=condition=ready pod -l app=prometheus -n {{ monitoring_namespace }} --timeout=120s
      ignore_errors: yes

    - name: Wait for Grafana
      command: /snap/bin/microk8s kubectl wait --for=condition=ready pod -l app=grafana -n {{ monitoring_namespace }} --timeout=120s
      ignore_errors: yes
