---
# ============================================================================
# Monitor App Deployment Playbook
# ============================================================================
#
# PURPOSE:
#   Deploy the Monitor App (React/Node) to MicroK8s.
#
# USAGE:
#   ansible-playbook -i inventory-production.yml deploy-monitor-app.yml
# ============================================================================

- name: Deploy Monitor App
  hosts: production-server
  become: yes
  gather_facts: yes

  vars:
    k8s_dir: "/opt/monitor-app/k8s"
    monitoring_namespace: "monitoring"
    app_name: "monitor-app"

  tasks:
    - name: Check if MicroK8s is running
      command: /snap/bin/microk8s status --wait-ready --timeout 10
      register: microk8s_status
      failed_when: false
      changed_when: false

    - name: Start MicroK8s if not running
      command: /snap/bin/microk8s start
      when: microk8s_status.rc != 0

    - name: Wait for MicroK8s to be ready
      command: /snap/bin/microk8s status --wait-ready
      when: microk8s_status.rc != 0
      changed_when: false
      retries: 10
      delay: 10
      register: microk8s_ready
      until: microk8s_ready.rc == 0

    - name: Create monitoring namespace
      command: /snap/bin/microk8s kubectl create namespace {{ monitoring_namespace }}
      register: create_ns
      failed_when: false
      changed_when: "'created' in create_ns.stdout"

    - name: Create monitoring directory
      file:
        path: "{{ k8s_dir }}"
        state: directory
        mode: "0755"

    - name: Copy Kubernetes manifests
      copy:
        src: "{{ playbook_dir }}/../../monitor-app/k8s/"
        dest: "{{ k8s_dir }}/"
        mode: "0644"

    - name: Pull Docker image
      community.docker.docker_image:
        name: "{{ docker_registry }}:{{ app_version }}"
        source: pull
      register: pull_result
      changed_when: "'Pulled' in (pull_result.actions | join(' '))"

    - name: Import image into MicroK8s
      shell: |
        docker save {{ docker_registry }}:{{ app_version }} -o /tmp/{{ app_name }}-{{ app_version }}.tar
        microk8s ctr images import /tmp/{{ app_name }}-{{ app_version }}.tar
        rm /tmp/{{ app_name }}-{{ app_version }}.tar
      args:
        executable: /bin/bash
      changed_when: true

    - name: Update Image in Deployment Manifest
      replace:
        path: "{{ k8s_dir }}/monitor-app-deployment.yaml"
        regexp: "image: .*"
        replace: "image: {{ docker_registry }}:{{ app_version }}"

    - name: Deploy Monitor App
      command: /snap/bin/microk8s kubectl apply -f {{ k8s_dir }}/monitor-app-deployment.yaml

    - name: Wait for pods to be ready
      command: /snap/bin/microk8s kubectl wait --for=condition=ready pod -l app={{ app_name }} -n {{ monitoring_namespace }} --timeout=120s
      changed_when: false
      failed_when: false

    - name: Display deployment summary
      debug:
        msg: |
          âœ… Monitor App Deployed!

          URL: http://{{ ansible_host }}:30001
          API: http://{{ ansible_host }}:30002

          Namespace: {{ monitoring_namespace }}
          Version: {{ app_version }}

    - name: Wait for Monitor App
      command: /snap/bin/microk8s kubectl wait --for=condition=ready pod -l app={{ app_name }} -n {{ monitoring_namespace }} --timeout=120s
      ignore_errors: yes
