groups:
  - name: infrastructure_alerts
    interval: 30s
    rules:
      # EC2 Instance Alerts
      - alert: HighCPUUsage
        expr: aws_ec2_cpuutilization_average > 80
        for: 5m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "High CPU usage on EC2 instance"
          description: "EC2 instance {{ $labels.dimension_InstanceId }} has CPU usage above 80% (current: {{ $value }}%)"

      - alert: CriticalCPUUsage
        expr: aws_ec2_cpuutilization_average > 95
        for: 2m
        labels:
          severity: critical
          component: infrastructure
        annotations:
          summary: "Critical CPU usage on EC2 instance"
          description: "EC2 instance {{ $labels.dimension_InstanceId }} has CPU usage above 95% (current: {{ $value }}%)"

      # Network Alerts
      - alert: HighNetworkTraffic
        expr: rate(aws_ec2_networkin_sum[5m]) > 100000000 # 100MB/s
        for: 10m
        labels:
          severity: warning
          component: network
        annotations:
          summary: "High network traffic detected"
          description: "EC2 instance {{ $labels.dimension_InstanceId }} has high network ingress (current: {{ $value | humanize }}B/s)"

      # EBS Volume Alerts
      - alert: HighEBSReadLatency
        expr: rate(aws_ebs_volumeread_bytes_sum[5m]) / rate(aws_ebs_volumeread_ops_sum[5m]) > 10000000 # 10MB per op
        for: 5m
        labels:
          severity: warning
          component: storage
        annotations:
          summary: "High EBS read latency"
          description: "EBS volume {{ $labels.dimension_VolumeId }} has high read latency"

      - alert: HighEBSIOPS
        expr: rate(aws_ebs_volumeconsumedreadwriteops_sum[5m]) > 3000
        for: 10m
        labels:
          severity: warning
          component: storage
        annotations:
          summary: "High EBS IOPS consumption"
          description: "EBS volume {{ $labels.dimension_VolumeId }} is consuming high IOPS (current: {{ $value }})"

  - name: application_alerts
    interval: 30s
    rules:
      # Service Down
      - alert: ServiceDown
        expr: up == 0
        for: 2m
        labels:
          severity: critical
          component: application
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.instance }} has been down for more than 2 minutes"

      # Container Alerts
      - alert: ContainerDown
        expr: absent(container_last_seen{name!=""})
        for: 2m
        labels:
          severity: critical
          component: container
        annotations:
          summary: "Container is down"
          description: "Container {{ $labels.name }} is not responding"

      - alert: HighContainerCPU
        expr: rate(container_cpu_usage_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          component: container
        annotations:
          summary: "High container CPU usage"
          description: "Container {{ $labels.name }} has high CPU usage ({{ $value | humanizePercentage }})"

      - alert: HighContainerMemory
        expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) > 0.9
        for: 5m
        labels:
          severity: warning
          component: container
        annotations:
          summary: "High container memory usage"
          description: "Container {{ $labels.name }} has high memory usage ({{ $value | humanizePercentage }})"

  - name: portal_cecre_alerts
    interval: 30s
    rules:
      - alert: PortalCECREDown
        expr: probe_success{instance="https://portal.cecre.net"} == 0
        for: 2m
        labels:
          severity: critical
          component: external
        annotations:
          summary: "Portal CECRE is down"
          description: "portal.cecre.net has been unreachable for more than 2 minutes"

      - alert: PortalCECRESlowResponse
        expr: probe_duration_seconds{instance="https://portal.cecre.net"} > 5
        for: 5m
        labels:
          severity: warning
          component: external
        annotations:
          summary: "Portal CECRE slow response"
          description: "portal.cecre.net is responding slowly ({{ $value }}s)"

  - name: storage_alerts
    interval: 30s
    rules:
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/mnt/ebs"} / node_filesystem_size_bytes{mountpoint="/mnt/ebs"}) < 0.2
        for: 5m
        labels:
          severity: warning
          component: storage
        annotations:
          summary: "Low disk space on EBS volume"
          description: "EBS volume /mnt/ebs has less than 20% free space ({{ $value | humanizePercentage }} free)"

      - alert: DiskSpaceCritical
        expr: (node_filesystem_avail_bytes{mountpoint="/mnt/ebs"} / node_filesystem_size_bytes{mountpoint="/mnt/ebs"}) < 0.1
        for: 2m
        labels:
          severity: critical
          component: storage
        annotations:
          summary: "Critical disk space on EBS volume"
          description: "EBS volume /mnt/ebs has less than 10% free space ({{ $value | humanizePercentage }} free)"

  - name: system_alerts
    interval: 30s
    rules:
      - alert: HighSystemMemory
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.9
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High system memory usage"
          description: "System memory usage is above 90% ({{ $value | humanizePercentage }})"

      - alert: HighSystemLoad
        expr: node_load15 / count(node_cpu_seconds_total{mode="idle"}) > 1.5
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "High system load"
          description: "System load is high ({{ $value }})"
