name: Terraform Deploy

on:
  workflow_dispatch:
    inputs:
      app_version:
        description: "App version to deploy"
        required: false
        default: "latest"
        type: string

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: us-east-1
  TF_VAR_aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
  TF_VAR_aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }} # Required for Terraform Cloud Backend
  DOCKER_REGISTRY: blacknash/cecre

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./infrastructure/terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.9.0
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -out=tfplan -input=false

      - name: Terraform Apply
        run: terraform apply -auto-approve -input=false tfplan

      - name: Generate Ansible Inventory
        id: inventory
        run: |
          echo "[production-server]" > ../../deployment/ansible/inventory.ini
          # We need to get the public IPs from the outputs. 
          # Note: We need to ensure outputs are defined in root outputs.tf
          IP1=$(terraform output -raw ec2_instance_1_public_ip)

          echo "server1 ansible_host=$IP1 ansible_user=ubuntu ansible_ssh_private_key_file=key.pem" >> ../../deployment/ansible/inventory.ini

          echo "" >> ../../deployment/ansible/inventory.ini
          echo "[all:vars]" >> ../../deployment/ansible/inventory.ini
          echo "production_ip=$IP1" >> ../../deployment/ansible/inventory.ini
          echo "app_name=school-portal" >> ../../deployment/ansible/inventory.ini
          echo "app_version=${{ inputs.app_version || 'latest' }}" >> ../../deployment/ansible/inventory.ini
          echo "docker_registry=${{ env.DOCKER_REGISTRY }}" >> ../../deployment/ansible/inventory.ini
          echo "production_domain=${{ secrets.PRODUCTION_DOMAIN }}" >> ../../deployment/ansible/inventory.ini
          echo "use_ip=${{ secrets.USE_IP || 'false' }}" >> ../../deployment/ansible/inventory.ini
          echo "use_https=${{ secrets.USE_HTTPS || 'true' }}" >> ../../deployment/ansible/inventory.ini
          echo "letsencrypt_email=${{ secrets.LETSENCRYPT_EMAIL }}" >> ../../deployment/ansible/inventory.ini
          echo "k8s_namespace=${{ secrets.K8S_NAMESPACE || 'default' }}" >> ../../deployment/ansible/inventory.ini

          cat ../../deployment/ansible/inventory.ini

      - name: Setup SSH Key
        run: |
          terraform output -raw private_key_pem > ../../deployment/ansible/key.pem
          chmod 600 ../../deployment/ansible/key.pem

      - name: Run Ansible Playbook
        uses: dawidd6/action-ansible-playbook@v2
        with:
          playbook: deployment/ansible/deploy-all.yml
          directory: ./
          # key: ${{ secrets.SSH_PRIVATE_KEY }}  <-- Removed this line
          inventory: deployment/ansible/inventory.ini
          options: |
            --verbose
