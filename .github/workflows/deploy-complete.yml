name: Deploy Complete Stack

on:
  workflow_dispatch:
    inputs:
      deploy_type:
        description: "Deployment Scope"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - infra-only
          - portal-only
          - monitor-stack-only
          - monitor-app-only
      portal_version:
        description: "Portal App Version (leave empty for package.json)"
        required: false
        type: string
      monitor_version:
        description: "Monitor App Version (leave empty for latest)"
        required: false
        type: string

env:
  DOCKER_REGISTRY_PORTAL: blacknash/cecre
  DOCKER_REGISTRY_MONITOR: blacknash/monitor

jobs:
  # ============================================================================
  # JOB 1: PREPARE & DEPLOY INFRASTRUCTURE (Terraform + Ansible Setup)
  # ============================================================================
  deploy-infra:
    name: 1. Deploy Infrastructure
    runs-on: ubuntu-latest
    outputs:
      ip: ${{ steps.tf_outputs.outputs.ip }}
      portal_version: ${{ steps.portal_ver.outputs.version }}
      monitor_version: ${{ steps.monitor_ver.outputs.version }}
      domain: ${{ steps.domain.outputs.domain }}
    steps:
      - uses: actions/checkout@v4

      # --- Version Extraction ---
      - name: Extract Portal Version
        id: portal_ver
        run: |
          VERSION="${{ github.event.inputs.portal_version }}"
          if [ -z "$VERSION" ]; then
            VERSION=$(node -p "require('./portal-app/package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Extract Monitor Version
        id: monitor_ver
        run: |
          VERSION="${{ github.event.inputs.monitor_version }}"
          if [ -z "$VERSION" ]; then
            VERSION="latest"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # --- Terraform Apply ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.9.0
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./infrastructure/terraform
        run: terraform init -input=false

      - name: Terraform Validate
        working-directory: ./infrastructure/terraform
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./infrastructure/terraform
        run: terraform plan -out=tfplan -input=false

      - name: Terraform Apply
        if: ${{ github.event.inputs.deploy_type == 'all' || github.event.inputs.deploy_type == 'infra-only' }}
        working-directory: ./infrastructure/terraform
        run: terraform apply -auto-approve -input=false tfplan

      - name: Fetch Terraform Outputs
        id: tf_outputs
        env:
          TF_IN_AUTOMATION: true
        run: |
          cd infrastructure/terraform
          # If we didn't apply (e.g. portal-only deploy), we still need outputs
          if [ ! -f tfplan ]; then terraform init -input=false; fi
          
          IP=$(terraform output -raw ec2_instance_1_public_ip)
          terraform output -raw private_key_pem > ../../private_key.pem
          chmod 600 ../../private_key.pem
          echo "ip=$IP" >> $GITHUB_OUTPUT

          # Upload key for next jobs
          mkdir -p ~/.ssh
          cp ../../private_key.pem ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Determine Domain
        id: domain
        run: |
          DOMAIN="${{ secrets.PRODUCTION_DOMAIN }}"
          [ -z "$DOMAIN" ] && DOMAIN="portal.cecre.net"
          echo "domain=$DOMAIN" >> $GITHUB_OUTPUT

      - name: Cache SSH Key
        uses: actions/cache@v3
        with:
          path: ~/.ssh/id_rsa
          key: ssh-key-${{ github.run_id }}

      # --- Ansible Setup ---
      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install ansible

      - name: Generate Inventory
        run: |
          mkdir -p deployment/ansible
          cat > deployment/ansible/inventory-github.yml <<EOF
          all:
            hosts:
              production-server:
                ansible_host: ${{ steps.tf_outputs.outputs.ip }}
                ansible_user: ubuntu
                ansible_ssh_private_key_file: ~/.ssh/id_rsa
                ansible_python_interpreter: /usr/bin/python3
                ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
                ansible_become: true
                ansible_become_method: sudo
                ansible_become_flags: "-n"
          EOF

      - name: Setup Infrastructure (Ansible)
        if: ${{ github.event.inputs.deploy_type == 'all' || github.event.inputs.deploy_type == 'infra-only' }}
        working-directory: ./deployment/ansible
        run: ansible-playbook -i inventory-github.yml setup-infrastructure.yml

      - name: Test Infrastructure (SSH)
        if: ${{ github.event.inputs.deploy_type == 'all' || github.event.inputs.deploy_type == 'infra-only' }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ steps.tf_outputs.outputs.ip }} "uptime"

  # ============================================================================
  # JOB 2: DEPLOY PORTAL APP
  # ============================================================================
  deploy-portal:
    name: 2. Deploy Portal App
    needs: deploy-infra
    if: ${{ github.event.inputs.deploy_type == 'all' || github.event.inputs.deploy_type == 'portal-only' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Restore SSH Key
        uses: actions/cache@v3
        with:
          path: ~/.ssh/id_rsa
          key: ssh-key-${{ github.run_id }}

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install ansible

      - name: Generate .env file
        run: |
          cat > .env <<EOF
          # Generated from GitHub Secrets
          REACT_APP_MSAL_CLIENT_ID=${{ secrets.REACT_APP_MSAL_CLIENT_ID }}
          REACT_APP_MSAL_TENANT_ID=${{ secrets.REACT_APP_MSAL_TENANT_ID }}
          REACT_APP_AZURE_CLIENT_ID=${{ secrets.REACT_APP_AZURE_CLIENT_ID }}
          REACT_APP_AZURE_TENANT_ID=${{ secrets.REACT_APP_AZURE_TENANT_ID }}
          REACT_APP_REDIRECT_URI=${{ secrets.REACT_APP_REDIRECT_URI }}
          REACT_APP_S3_BUCKET_NAME=${{ secrets.REACT_APP_S3_BUCKET_NAME }}
          REACT_APP_S3_REGION=${{ secrets.REACT_APP_S3_REGION }}
          REACT_APP_S3_ACCESS_KEY_ID=${{ secrets.REACT_APP_S3_ACCESS_KEY_ID }}
          REACT_APP_S3_SECRET_ACCESS_KEY=${{ secrets.REACT_APP_S3_SECRET_ACCESS_KEY }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
          REACT_APP_SENTRY_DSN=${{ secrets.REACT_APP_SENTRY_DSN }}
          REACT_APP_SENTRY_ENVIRONMENT=${{ secrets.REACT_APP_SENTRY_ENVIRONMENT }}
          REACT_APP_ENABLE_SENTRY=${{ secrets.REACT_APP_ENABLE_SENTRY }}
          SENTRY_DSN=${{ secrets.SENTRY_DSN }}
          REACT_APP_WORDPRESS_FEED_URL=${{ secrets.REACT_APP_WORDPRESS_FEED_URL }}
          REACT_APP_GOOGLE_CLIENT_ID=${{ secrets.REACT_APP_GOOGLE_CLIENT_ID }}
          NODE_ENV=production
          PORT=3000
          HTTPS_PORT=443
          EOF

      - name: Generate Inventory
        run: |
          mkdir -p deployment/ansible
          cat > deployment/ansible/inventory-github.yml <<EOF
          all:
            hosts:
              production-server:
                ansible_host: ${{ needs.deploy-infra.outputs.ip }}
                ansible_user: ubuntu
                ansible_ssh_private_key_file: ~/.ssh/id_rsa
                ansible_python_interpreter: /usr/bin/python3
                ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
                ansible_become: true
                ansible_become_method: sudo
                ansible_become_flags: "-n"
            vars:
              app_name: school-portal
              app_version: "${{ needs.deploy-infra.outputs.portal_version }}"
              docker_registry: ${{ env.DOCKER_REGISTRY_PORTAL }}
              production_ip: ${{ needs.deploy-infra.outputs.ip }}
              production_domain: "${{ needs.deploy-infra.outputs.domain }}"
              use_ip: "${{ secrets.USE_IP || 'false' }}"
              use_https: "${{ secrets.USE_HTTPS || 'true' }}"
              letsencrypt_email: ${{ secrets.LETSENCRYPT_EMAIL }}
              k8s_namespace: ${{ secrets.K8S_NAMESPACE || 'default' }}
          EOF

      - name: Deploy Portal App
        working-directory: ./deployment/ansible
        run: ansible-playbook -i inventory-github.yml deploy-app.yml

      - name: Test Portal App (Curl)
        run: |
          # Wait a bit for ingress
          sleep 30
          curl -k -v https://${{ needs.deploy-infra.outputs.ip }}:3443 || curl -v http://${{ needs.deploy-infra.outputs.ip }}:3000

  # ============================================================================
  # JOB 3: DEPLOY MONITOR APP
  # ============================================================================
  deploy-monitor-app:
    name: 3. Deploy Monitor App
    needs: [deploy-infra, deploy-portal]
    if: ${{ always() && (github.event.inputs.deploy_type == 'all' || github.event.inputs.deploy_type == 'monitor-app-only') && needs.deploy-infra.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Restore SSH Key
        uses: actions/cache@v3
        with:
          path: ~/.ssh/id_rsa
          key: ssh-key-${{ github.run_id }}

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install ansible

      - name: Generate Inventory
        run: |
          mkdir -p deployment/ansible
          cat > deployment/ansible/inventory-github.yml <<EOF
          all:
            hosts:
              production-server:
                ansible_host: ${{ needs.deploy-infra.outputs.ip }}
                ansible_user: ubuntu
                ansible_ssh_private_key_file: ~/.ssh/id_rsa
                ansible_python_interpreter: /usr/bin/python3
                ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
                ansible_become: true
                ansible_become_method: sudo
                ansible_become_flags: "-n"
            vars:
              docker_registry: ${{ env.DOCKER_REGISTRY_MONITOR }}
              app_version: "${{ needs.deploy-infra.outputs.monitor_version }}"
              monitoring_namespace: monitoring
          EOF

      - name: Deploy Monitor App
        working-directory: ./deployment/ansible
        run: ansible-playbook -i inventory-github.yml deploy-monitor-app.yml

      - name: Test Monitor App
        run: |
          # Basic check if pod is running via SSH
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ needs.deploy-infra.outputs.ip }} "/snap/bin/microk8s kubectl get pods -n monitoring -l app=monitor-app | grep monitor-app"

  # ============================================================================
  # JOB 4: DEPLOY MONITORING STACK (Prometheus/Grafana)
  # ============================================================================
  deploy-monitor-stack:
    name: 4. Deploy Monitoring Stack
    needs: [deploy-infra, deploy-monitor-app]
    if: ${{ always() && (github.event.inputs.deploy_type == 'all' || github.event.inputs.deploy_type == 'monitor-stack-only') && needs.deploy-infra.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Restore SSH Key
        uses: actions/cache@v3
        with:
          path: ~/.ssh/id_rsa
          key: ssh-key-${{ github.run_id }}

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install ansible

      - name: Generate Inventory
        run: |
          mkdir -p deployment/ansible
          cat > deployment/ansible/inventory-github.yml <<EOF
          all:
            hosts:
              production-server:
                ansible_host: ${{ needs.deploy-infra.outputs.ip }}
                ansible_user: ubuntu
                ansible_ssh_private_key_file: ~/.ssh/id_rsa
                ansible_python_interpreter: /usr/bin/python3
                ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
                ansible_become: true
                ansible_become_method: sudo
                ansible_become_flags: "-n"
            vars:
              monitoring_namespace: monitoring
          EOF

      - name: Deploy Monitoring Stack
        working-directory: ./deployment/ansible
        run: ansible-playbook -i inventory-github.yml deploy-monitoring-stack.yml

      - name: Test Monitoring Stack
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ needs.deploy-infra.outputs.ip }} "/snap/bin/microk8s kubectl get pods -n monitoring -l app=prometheus | grep prometheus"
