name: Deploy Monitoring Stack Only

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Monitoring Stack
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.9.0
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false

      - name: Fetch Terraform Outputs
        id: tf_outputs
        env:
          TF_IN_AUTOMATION: true
        run: |
          cd infrastructure/terraform
          terraform init -input=false
          IP=$(terraform output -raw ec2_instance_1_public_ip)
          terraform output -raw private_key_pem > ../../private_key.pem
          chmod 600 ../../private_key.pem
          echo "ip=$IP" >> $GITHUB_OUTPUT

      - name: Generate Inventory
        run: |
          mkdir -p deployment/ansible
          cat > deployment/ansible/inventory-github.yml <<EOF
          all:
            hosts:
              production-server:
                ansible_host: ${{ steps.tf_outputs.outputs.ip }}
                ansible_user: ubuntu
                ansible_ssh_private_key_file: ${{ github.workspace }}/private_key.pem
                ansible_python_interpreter: /usr/bin/python3
                ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
                ansible_become: true
                ansible_become_method: sudo
                ansible_become_flags: "-n"
            vars:
              monitoring_namespace: monitoring
          EOF

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ steps.tf_outputs.outputs.ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install ansible

      - name: Deploy
        working-directory: ./deployment/ansible
        run: ansible-playbook -i inventory-github.yml deploy-monitoring-stack.yml

      - name: Cleanup
        if: always()
        run: rm -f private_key.pem
