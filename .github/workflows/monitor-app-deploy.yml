name: Deploy Monitoring Stack

on:
  workflow_dispatch:

env:
  DOCKER_IMAGE: blacknash/monitor

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: monitor-app/package-lock.json

      - name: Install Dependencies
        working-directory: ./monitor-app
        run: npm ci

      - name: Lint
        working-directory: ./monitor-app
        run: npm run lint

      # Add test step here if you have tests
      # - name: Test
      #   working-directory: ./monitor-app
      #   run: npm test

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    env:
      IMAGE_TAG: sha-${{ github.sha }}
    outputs:
      image_tag: ${{ steps.image_tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Capture image tag
        id: image_tag
        run: echo "tag=${IMAGE_TAG}" >> "$GITHUB_OUTPUT"

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=raw,value=${{ env.IMAGE_TAG }}
            type=ref,event=branch
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./monitor-app
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    env:
      IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.9.0
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false

      - name: Fetch Terraform Outputs
        id: tf_outputs
        env:
          TF_IN_AUTOMATION: true
        run: |
          cd infrastructure/terraform
          terraform init -input=false

          IP=$(terraform output -raw ec2_instance_1_public_ip)
          terraform output -raw private_key_pem > ../../private_key.pem
          chmod 600 ../../private_key.pem

          echo "ip=$IP" >> $GITHUB_OUTPUT

      - name: Generate dynamic inventory file
        run: |
          mkdir -p deployment/ansible
          cat > deployment/ansible/inventory-github.yml <<EOF
          all:
            hosts:
              production-server:
                ansible_host: ${{ steps.tf_outputs.outputs.ip }}
                ansible_user: ubuntu
                ansible_ssh_private_key_file: ${{ github.workspace }}/private_key.pem
                ansible_python_interpreter: /usr/bin/python3
                ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
                ansible_become: true
                ansible_become_method: sudo
                ansible_become_flags: "-n"

            vars:
              app_name: monitor-app
              docker_registry: ${{ env.DOCKER_IMAGE }}
              app_version: "${{ env.IMAGE_TAG }}"
              monitoring_namespace: monitoring
              k8s_namespace: monitoring
              production_ip: ${{ steps.tf_outputs.outputs.ip }}
          EOF
          echo "‚úÖ Inventory file generated"

      - name: Setup SSH known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ steps.tf_outputs.outputs.ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install ansible
          ansible --version

      - name: Deploy monitoring via Ansible
        working-directory: ./deployment/ansible
        run: |
          ansible-playbook -i inventory-github.yml deploy-monitoring.yml

      - name: Cleanup
        if: always()
        run: rm -f private_key.pem

      - name: Deployment summary
        if: success()
        run: |
          echo "‚úÖ Monitoring stack deployed via Ansible"
          echo "üì¶ Image: ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}"
          echo "üåê Host: ${{ steps.tf_outputs.outputs.ip }}"
